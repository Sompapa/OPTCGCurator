<!doctype html>
<html lang="hu">

<head>
  <meta charset="UTF-8" />
  <title>One Piece TCG Manager</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }

    .container {
      max-width: 1100px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px;
      margin-bottom: 30px;
    }

    .card-item {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
      border-radius: 5px;
      cursor: pointer;
      background: #fff;
      transition: 0.2s;
      font-size: 14px;
    }

    .card-item:hover {
      background: #e0f7fa;
      border-color: #00bcd4;
      transform: translateY(-2px);
    }

    h1 {
      color: #2c3e50;
      text-align: center;
    }

    h2 {
      color: #34495e;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }

    .cards-display {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 25px;
      margin-top: 30px;
      padding: 10px;
    }

    .card-box {
      background: #fff;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
    }

    .card-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .card-img {
      width: 100%;
      aspect-ratio: 5 / 7;
      border-radius: 8px;
      object-fit: contain;
      background: #eee;
      margin-bottom: 10px;
    }

    .card-info {
      text-align: center;
      font-size: 0.9em;
      flex-grow: 1;
    }

    .add-btn {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      font-weight: bold;
      margin-top: 10px;
    }

    .add-btn:hover {
      background-color: #2980b9;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>One Piece TCG - Collection Curator</h1>
    <div style="text-align: center; margin-bottom: 20px;">
      <button onclick="loadMyCollection()"
              style="background-color: #27ae60; color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: 0.2s;">
              <span style="margin-right: 8px;"></span> View My Collection
      </button>
    </div>
    <div style="display: flex; gap: 20px; justify-content: center; margin-bottom: 30px; flex-wrap: wrap;">
        
        <div style="flex: 1; min-width: 250px; max-width: 400px;">
            <h3 style="color: #34495e; margin-bottom: 10px;">Main Sets</h3>
            <input list="main-sets-list" id="mainSetInput" 
                   onchange="handleDropdownSelect(this.value, 'starterDeckInput')" 
                   placeholder="Search for set (ex. Romance)..." 
                   style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #bdc3c7; font-size: 16px; outline: none; box-sizing: border-box;">
            <datalist id="main-sets-list"></datalist>
        </div>

        <div style="flex: 1; min-width: 250px; max-width: 400px;">
            <h3 style="color: #34495e; margin-bottom: 10px;">Starter Decks</h3>
            <input list="starter-decks-list" id="starterDeckInput" 
                   onchange="handleDropdownSelect(this.value, 'mainSetInput')" 
                   placeholder="Search for starter (ex. st01)..." 
                   style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #bdc3c7; font-size: 16px; outline: none; box-sizing: border-box;">
            <datalist id="starter-decks-list"></datalist>
        </div>

      </div>
    <div id="search-container" style="display: none; margin-bottom: 20px; text-align: center;">
      <input type="text" id="searchInput" oninput="filterCards()" placeholder="Search with name of ID..."
        style="width: 100%; max-width: 400px; padding: 12px; border-radius: 8px; border: 2px solid #3498db; font-size: 16px; outline: none;">

      <select id="sortSelect" onchange="sortCards()"
        style="padding: 12px; border-radius: 8px; border: 2px solid #2c3e50; font-size: 16px; outline: none; margin-left: 10px; cursor: pointer;">
        <option value="id_asc">Sort by ID (increasing)</option>
        <option value="id_desc">Sort by ID (decreasing)</option>
        <option value="name_asc">Sort by name (A-Z)</option>
        <option value="name_desc">Sort by name (Z-A)</option>
      </select>
    </div>
    <h2 id="current-set-title">Choose a set!</h2>
    <div id="cards-display" class="cards-display"></div>
  </div>

  <script>
      const setIdMap = {};
      function handleDropdownSelect(selectedValue, otherInputId) {
          const setId = setIdMap[selectedValue];
          if (setId) {

              document.getElementById(otherInputId).value = ""; 
              
              loadSetCards(setId);
          }
      }

      async function loadSources() {
        try {
          console.log("Leading sources...");
          const response = await fetch("/api/all-sources");
          if (!response.ok) throw new Error("API error!");
          
          const data = await response.json();
          
          const mainList = document.getElementById("main-sets-list");
          const starterList = document.getElementById("starter-decks-list");

          if (data.mainSets) {
            data.mainSets.forEach(set => {
              const displayName = `${set.set_name} (${set.set_id})`;
              setIdMap[displayName] = set.set_id;
              
              const option = document.createElement("option");
              option.value = displayName;
              mainList.appendChild(option);
            });
          }

          if (data.starterDecks) {
            data.starterDecks.forEach(deck => {
              const displayName = `${deck.structure_deck_name} (${deck.structure_deck_id})`;
              setIdMap[displayName] = deck.structure_deck_id;
              
              const option = document.createElement("option");
              option.value = displayName;
              starterList.appendChild(option);
            });
          }
        } catch (e) {
          console.error("Error during load:", e);
          alert("Error during data fetch. Check the server!");
        }
      }

    // 3. Show Cards
    async function loadSetCards(id) {
      const display = document.getElementById('cards-display');
      const title = document.getElementById('current-set-title');
      const searchContainer = document.getElementById('search-container');
      const searchInput = document.getElementById('searchInput');

      title.innerText = "Loading cards: " + id;
      display.innerHTML = 'Searching for cards...';
      searchContainer.style.display = "none";

      try {
        const response = await fetch(`/api/view/${id}`);
        const data = await response.json();
        display.innerHTML = '';

        let cardList = Array.isArray(data) ? data : (data.cards || []);
        //With name and numbering formating
        cardList.forEach(card => {
          const div = document.createElement('div');
          div.className = 'card-box';

          let rawName = card.card_name || card.name || "Unknown";
          const img = card.card_image || card.image_url || card.image || "";
          let cardNumber = card.card_number || card.card_id || card.id || "";

          const cleanId = id.replace(/^(OP|ST|EB|PRB)-(\d+)/i, '$1$2').toUpperCase();

          const idMatch = rawName.match(/\(([^)]*\d[^)]*)\)/);
          if (idMatch && !cardNumber) {
            cardNumber = idMatch[1];
          }

          let cleanName = rawName.replace(/\s*\([^)]*\d[^)]*\)/g, '').trim();

          if (!cardNumber && img.includes('/')) {
            const filename = img.split('/').pop();
            cardNumber = filename.split('.')[0];
          }

          if (!cardNumber) cardNumber = "N/A";

          // Cleaning serialnumbers
          if (cardNumber !== "N/A") {
            cardNumber = cardNumber.split('_')[0].toUpperCase();

            cardNumber = cardNumber.replace(/^(OP|ST|EB|PRB)-(\d+)/i, '$1$2');

            if (!cardNumber.includes(cleanId)) {
              cardNumber = `${cleanId}-${cardNumber.replace(/^-/, '')}`;
            }
          }

          const cardBackImg = "https://world.onepiece-cardgame.com/images/common/cardback.png";

          div.innerHTML = `
                <img class="card-img" 
                     src="${img ? img : cardBackImg}" 
                     alt="${cleanName}" 
                     onerror="this.onerror=null; this.src='${cardBackImg}';">
                <div class="card-info">
                    <strong>${cardNumber}</strong><br>
                    <span>${cleanName}</span>
                </div>
                <button class="add-btn" onclick="addToCollection('${cardNumber}', '${cleanName.replace(/'/g, "\\'")}', '${img ? img : cardBackImg}')">
                    + Add to Collection
                </button>
            `;
          display.appendChild(div);
        });
        title.innerText = id + " Cards (" + cardList.length + ")";

        if (cardList.length > 0) {
          searchInput.value = "";
          searchContainer.style.display = "block";

          setTimeout(() => {
            document.getElementById('sortSelect').value = 'id_asc';
            sortCards();
          }, 50);
        } else {
          display.innerHTML = "Card can not be found.";
        }

      } catch (e) {
        console.error("Error:", e);
        display.innerHTML = "Error loading cards.";
      }
    }

    // 4. Collection adder
    async function addToCollection(id, name, img) {
      try {
        const response = await fetch("/api/collection/add", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            card_id: id,
            card_name: name,
            image_url: img,
          }),
        });
        const result = await response.json();
        if (result.success) alert("Card is added to the collection!");
      } catch (e) {
        alert("Error during save!");
      }
    }

    async function removeFromCollection(id) {
        try {
            const response = await fetch("/api/collection/remove", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ card_id: id }),
            });
            const result = await response.json();
            
            if (result.success) {
                // Refresh after remval
                loadMyCollection();
            }
        } catch (e) {
            alert("Error during the delet!");
        }
    }

    // 5. My Collection
      async function loadMyCollection() {
        const display = document.getElementById('cards-display');
        const title = document.getElementById('current-set-title');
        const searchContainer = document.getElementById('search-container');
        const searchInput = document.getElementById('searchInput');

        title.innerText = "Loading My Collection...";
        display.innerHTML = 'Reading database...';
        searchContainer.style.display = "none";

        try {
            const response = await fetch("/api/collection/view");
            const myCards = await response.json();
            display.innerHTML = '';

            if (myCards.length === 0) {
                display.innerHTML = "<p style='text-align:center; width: 100%; font-size: 18px;'>Your collection is empty, search for crads to add them!</p>";
                title.innerText = "My Collection (0)";
                return;
            }

            myCards.forEach(card => {
                const div = document.createElement('div');
                div.className = 'card-box';

                const cardNumber = card.card_id;
                const cleanName = card.card_name;
                const img = card.image_url;
                const quantity = card.quantity;

             div.innerHTML = `
                    <img class="card-img" 
                         src="${img}" 
                         alt="${cleanName}" 
                         onerror="this.src='https://world.onepiece-cardgame.com/images/common/cardback.png';">
                    <div class="card-info">
                        <strong>${cardNumber}</strong><br>
                        <span>${cleanName}</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; width: 100%; gap: 5px;">
                        <div style="background: #f39c12; color: white; padding: 8px; border-radius: 5px; font-weight: bold; flex-grow: 1; text-align: center;">
                            Owned: ${quantity}x
                        </div>
                        <button onclick="removeFromCollection('${cardNumber}')" 
                                style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s;"
                                onmouseover="this.style.background='#c0392b'" 
                                onmouseout="this.style.background='#e74c3c'">
                            -1
                        </button>
                    </div>
                `;
                display.appendChild(div);
            });

            title.innerText = "My Collection (" + myCards.length + " unique cards)";
            searchInput.value = ""; 
            searchContainer.style.display = "block";
            setTimeout(() => {
                document.getElementById('sortSelect').value = 'id_asc';
                sortCards();
            }, 50);

        } catch (e) {
            console.error("Error:", e);
            display.innerHTML = "Error loading collection.";
        }
      }

    // 5. Filter & Sort
    function filterCards() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      const cards = document.querySelectorAll('.card-box');

      cards.forEach(card => {
        const text = card.innerText.toLowerCase();
        card.style.display = text.includes(query) ? "flex" : "none";
      });
    }

    function sortCards() {
      const display = document.getElementById('cards-display');
      const cards = Array.from(display.getElementsByClassName('card-box'));
      const sortMode = document.getElementById('sortSelect').value;

      cards.sort((a, b) => {

        const idA = a.querySelector('.card-info strong')?.innerText || "";
        const idB = b.querySelector('.card-info strong')?.innerText || "";
        const nameA = a.querySelector('.card-info span')?.innerText || "";
        const nameB = b.querySelector('.card-info span')?.innerText || "";

        if (sortMode === 'id_asc') {
          return idA.localeCompare(idB, undefined, { numeric: true });
        } else if (sortMode === 'id_desc') {
          return idB.localeCompare(idA, undefined, { numeric: true });
        } else if (sortMode === 'name_asc') {
          return nameA.localeCompare(nameB);
        } else if (sortMode === 'name_desc') {
          return nameB.localeCompare(nameA);
        }
      });


      cards.forEach(card => display.appendChild(card));
    }

    window.onload = loadSources;

  </script>
</body>

</html>