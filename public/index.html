<!doctype html>
<html lang="hu">
  <head>
    <meta charset="UTF-8" />
    <title>One Piece TCG Manager</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f4f4f4;
        padding: 20px;
      }
      .container {
        max-width: 1100px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 10px;
        margin-bottom: 30px;
      }
      .card-item {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: center;
        border-radius: 5px;
        cursor: pointer;
        background: #fff;
        transition: 0.2s;
        font-size: 14px;
      }
      .card-item:hover {
        background: #e0f7fa;
        border-color: #00bcd4;
        transform: translateY(-2px);
      }
      h1 {
        color: #2c3e50;
        text-align: center;
      }
      h2 {
        color: #34495e;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
      }

      .cards-display {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 25px;
        margin-top: 30px;
        padding: 10px;
      }

      .card-box {
        background: #fff;
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
      }

      .card-box:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .card-img {
        width: 100%;
        aspect-ratio: 5 / 7; /* Kártya arány megtartása */
        border-radius: 8px;
        object-fit: contain;
        background: #eee; /* Amíg tölt a kép, ne legyen üres */
        margin-bottom: 10px;
      }

      .card-info {
        text-align: center;
        font-size: 0.9em;
        flex-grow: 1;
      }

      .add-btn {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        width: 100%;
        font-weight: bold;
        margin-top: 10px;
      }

      .add-btn:hover {
        background-color: #2980b9;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>One Piece TCG - Collection Curator</h1>

      <h2>Sets and Starters</h2>
      <div id="sets-grid" class="grid">Loading...</div>

      <h2 id="current-set-title">Choose a set!</h2>
      <div id="cards-display" class="cards-display"></div>
    </div>

    <script>
      // 1. Create Button
      function createButton(container, name, id) {
        const div = document.createElement("div");
        div.className = "card-item";
        div.innerText = name;
        div.onclick = () => loadSetCards(id);
        container.appendChild(div);
      }

      // 2. Load Sets and starters
      async function loadSources() {
        try {
          console.log("Források lekérése...");
          const response = await fetch("/api/all-sources");
          const data = await response.json();
          const grid = document.getElementById("sets-grid");
          grid.innerHTML = "";

          if (data.mainSets) {
            data.mainSets.forEach((set) =>
              createButton(grid, set.set_name, set.set_id),
            );
          }

          if (data.starterDecks) {
            data.starterDecks.forEach((deck) =>
              createButton(
                grid,
                deck.structure_deck_name,
                deck.structure_deck_id,
              ),
            );
          }
        } catch (e) {
          console.error("Hiba a betöltéskor:", e);
          document.getElementById("sets-grid").innerText =
            "Hiba az adatok lekérésekor.";
        }
      }

      // 3. Show Cards
async function loadSetCards(id) {
    const display = document.getElementById('cards-display');
    const title = document.getElementById('current-set-title');

    title.innerText = "Loading cards: " + id;
    display.innerHTML = 'Searching for cards...';

    try {
        const response = await fetch(`/api/view/${id}`);
        const data = await response.json();
        display.innerHTML = '';

        const cardList = Array.isArray(data) ? data : (data.cards || []);

        cardList.forEach(card => {
            const div = document.createElement('div');
            div.className = 'card-box';

            const name = card.card_name || card.name || "Unknown";
            const img = card.card_image || card.image_url || card.image;
            const cardNumber = card.card_number || card.id || "N/A";

            const cardBackImg = "https://world.onepiece-cardgame.com/images/common/cardback.png";

            div.innerHTML = `
                <img class="card-img" 
                     src="${img ? img : cardBackImg}" 
                     alt="${name}" 
                     onerror="this.onerror=null; this.src='${cardBackImg}';">
                <div class="card-info">
                    <strong>${cardNumber}</strong><br>
                    <span>${name}</span>
                </div>
                <button class="add-btn" onclick="addToCollection('${cardNumber}', '${name.replace(/'/g, "\\'")}', '${img ? img : cardBackImg}')">
                    + Add to Collection
                </button>
            `;
            display.appendChild(div);
        });
        title.innerText = id + " Cards (" + cardList.length + ")";
    } catch (e) {
        console.error("Hiba:", e);
        display.innerHTML = "Error loading cards.";
    }
}

      // Collection adder
      async function addToCollection(id, name, img) {
        const response = await fetch("/api/collection/add", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            card_id: id,
            card_name: name,
            image_url: img,
          }),
        });
        const result = await response.json();
        if (result.success) alert("Kártya elmentve!");
      }

      window.onload = loadSources;
    </script>
  </body>
</html>
